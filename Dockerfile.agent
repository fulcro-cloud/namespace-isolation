FROM golang:1.25-alpine AS builder

RUN apk add --no-cache git make ca-certificates tzdata

WORKDIR /build

COPY go.mod go.sum* ./
RUN go mod download

COPY . .

ARG VERSION=dev
ARG COMMIT=unknown
ARG BUILD_DATE=unknown
ARG TARGETARCH

RUN CGO_ENABLED=0 GOOS=linux GOARCH=${TARGETARCH} go build \
    -ldflags="-w -s \
        -X main.Version=${VERSION} \
        -X main.Commit=${COMMIT} \
        -X main.BuildDate=${BUILD_DATE}" \
    -o /build/bin/namespace-isolator-agent \
    ./cmd/agent

FROM alpine:3.20

LABEL org.opencontainers.image.title="Namespace Isolator Agent" \
      org.opencontainers.image.description="Agent that enforces namespace resource isolation via cgroups" \
      org.opencontainers.image.vendor="Fulcro Tecnologia LTDA" \
      org.opencontainers.image.source="https://github.com/fulcro-cloud/namespace-isolator"

# ca-certificates: TLS to API server
# tzdata: timezone handling
# util-linux: nsenter for host systemd access
RUN apk add --no-cache ca-certificates tzdata util-linux \
    && rm -rf /var/cache/apk/*

RUN addgroup -g 1000 isolator && \
    adduser -u 1000 -G isolator -s /bin/sh -D isolator

COPY --from=builder /build/bin/namespace-isolator-agent /usr/local/bin/namespace-isolator-agent
RUN chmod +x /usr/local/bin/namespace-isolator-agent

# Runs as root for /sys/fs/cgroup access
USER root

HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD ["/usr/local/bin/namespace-isolator-agent", "--health-check"] || exit 1

ENTRYPOINT ["/usr/local/bin/namespace-isolator-agent"]
CMD ["--cgroup-root=/sys/fs/cgroup", "--sync-interval=30s"]
